<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Школьный Чат</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;min-height:100vh;padding:20px}
    .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:20px;padding:25px;border:1px solid rgba(255,255,255,0.2)}
    h1{font-size:24px;text-align:center;margin-bottom:10px}
    p{text-align:center;opacity:0.9;font-size:14px;margin-bottom:20px}
    .btns{display:grid;gap:12px;margin:20px 0}
    button{background:rgba(255,255,255,0.2);border:none;border-radius:15px;padding:18px;color:#fff;font-size:16px;cursor:pointer;transition:.3s}
    button.active{background:rgba(255,255,255,0.4);border:2px solid #fff}
    textarea{width:100%;height:150px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.3);border-radius:15px;padding:15px;color:#fff;font-size:16px;margin:10px 0;resize:none}
    textarea:focus{outline:none;border-color:#fff;background:rgba(255,255,255,0.2)}
    .send{width:100%;background:#4CAF50;padding:20px;font-size:18px;border-radius:15px;border:none;color:#fff;margin-top:10px;cursor:pointer}
    .send:disabled{background:#666;cursor:not-allowed}
    .id{background:rgba(255,255,255,0.1);padding:12px;border-radius:12px;text-align:center;margin:15px 0;font-family:monospace;font-size:15px}
    .status{text-align:center;margin:15px 0;padding:12px;border-radius:12px;font-weight:500}
    .success{background:rgba(76,175,80,0.4);border:1px solid rgba(76,175,80,0.6)}
    .error{background:rgba(244,67,54,0.4);border:1px solid rgba(244,67,54,0.6)}
  </style>
</head>
<body>
  <div class="card">
    <h1>Школьный Чат</h1>
    <p>Анонимные обращения</p>

    <div class="btns">
      <button class="active" data-type="idea">Идея</button>
      <button data-type="question">Вопрос</button>
      <button data-type="complaint">Проблема</button>
    </div>

    <textarea id="text" placeholder="Опишите подробно (минимум 10 символов)..."></textarea>

    <div class="id">Ваш номер: <b id="id">STU-XXXXXX</b></div>

    <div id="status"></div>

    <button id="send" class="send">Отправить</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const textarea = document.getElementById('text');
    const status = document.getElementById('status');
    const sendBtn = document.getElementById('send');
    let type = 'idea';
    const anonymousId = 'STU-' + Math.random().toString(36).substr(2,4).toUpperCase() + Math.random().toString(10).substr(2,2);
    document.getElementById('id').textContent = anonymousId;

    // Определяем платформу
    const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
    const isAndroid12orLower = /Android\s([1-9]|1[0-2])/.test(navigator.userAgent);

    document.querySelectorAll('[data-type]').forEach(b => {
      b.onclick = () => {
        document.querySelectorAll('[data-type]').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        type = b.dataset.type;
      };
    });

    sendBtn.onclick = () => {
      const text = textarea.value.trim();
      if (text.length < 10) {
        status.innerHTML = '<div class="status error">Минимум 10 символов!</div>';
        return;
      }

      sendBtn.disabled = true;
      sendBtn.textContent = 'Отправка...';
      status.innerHTML = '<div class="status">Готовим данные...</div>';

      const payload = {
        action: "submit_feedback",
        anonymous_id: anonymousId,
        type: type,
        text: text,
        timestamp: new Date().toISOString()
      };
      const json = JSON.stringify(payload);
      const base64 = btoa(unescape(encodeURIComponent(json)));
      const magicText = "WEBAPP_DATA:" + base64;

      // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
      // ЗАМЕНИ НА СВОЙ БОТ (без @)
      const BOT_USERNAME = "new_otziv_Bot";
      // ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑

      // === iOS или нормальный Android — пробуем sendData ===
      if (isIOS || !isAndroid12orLower) {
        try {
          tg.sendData(json);
          status.innerHTML = '<div class="status success">Отправлено!</div>';
          sendBtn.textContent = 'Готово';
          setTimeout(() => tg.close(), 1500);
          return;
        } catch (e) {
          console.log("sendData упал, переходим на fallback");
        }
      }

      // === Android 12 и ниже — сразу fallback ===
      const url = `https://t.me/${BOT_USERNAME}?text=${encodeURIComponent(magicText)}`;
      status.innerHTML = '<div class="status success">Открываем чат — нажмите «Отправить»</div>';
      sendBtn.textContent = 'Открываем...';

      setTimeout(() => {
        tg.openTelegramLink(url);
        setTimeout(() => tg.close(), 1500);
      }, 800);
    };

    // Ctrl+Enter
    textarea.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') sendBtn.click();
    });
  </script>
</body>
</html>
