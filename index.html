<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–®–∫–æ–ª—å–Ω—ã–π –ß–∞—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –î–æ–ø—É—Å—Ç–∏–º, –≤–∞—à —Å—Ç–∏–ª—å –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—Ä–∏–º–µ—Ä–µ */
    /* ... */
    .send-btn {
      width: 100%;
      background: linear-gradient(135deg, #2196f3, #1976d2);
      border: none;
      border-radius: 15px;
      padding: 20px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
    }
    .send-btn:disabled {
      background: rgba(255, 255, 255, 0.2);
      cursor: not-allowed;
      box-shadow: none;
    }
    .fallback-button {
      background: linear-gradient(135deg, #4caf50, #388e3c);
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ HTML –∫–∞–∫ —É –≤–∞—Å -->
  <!-- ... -->
  <button id="send" class="send-btn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
  <div id="status"></div>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const textarea = document.getElementById('text');
    const statusDiv = document.getElementById('status');
    const sendBtn = document.getElementById('send');

    let category = 'idea';
    let anonymousId = '';
    function generateAnonymousId() {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const numbers = '0123456789';
      let letterPart = '';
      for (let i=0; i<4; i++) letterPart += letters.charAt(Math.floor(Math.random()*letters.length));
      let numberPart = '';
      for(let i=0; i<2; i++) numberPart += numbers.charAt(Math.floor(Math.random()*numbers.length));
      return `STU-${letterPart}${numberPart}`;
    }
    function initAnonymousId() {
      anonymousId = generateAnonymousId();
      document.getElementById('anonymousId').textContent = anonymousId;
    }
    initAnonymousId();

    // –ü—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        category = btn.getAttribute('data-category');
        const placeholders = {
          idea: '–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∏–¥–µ—é –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —à–∫–æ–ª—ã...',
          question: '–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ–¥—Ä–æ–±–Ω–æ...',
          complaint: '–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É, —Å –∫–æ—Ç–æ—Ä–æ–π —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å...'
        };
        textarea.placeholder = placeholders[category] || '–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ...';
      });
    });

    sendBtn.addEventListener('click', () => {
      if(sendBtn.disabled) return;
      const text = textarea.value.trim();
      if(!text) {
        setStatus('error', '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è');
        return;
      }
      if(text.length < 10) {
        setStatus('error', '‚ùå –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)');
        return;
      }

      sendBtn.disabled = true;
      sendBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ...';
      setStatus('info', '‚åõ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º...');

      const data = {
        action: 'submit_feedback',
        anonymous_id: anonymousId,
        type: category,
        text: text,
        timestamp: new Date().toISOString()
      };

      // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ sendData (–º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å)
      try {
        tg.sendData(JSON.stringify(data));
        console.log('sendData –≤—ã–∑–≤–∞–Ω');
      } catch(e) {
        console.warn('sendData –≤—ã–∑–≤–∞–Ω —Å –æ—à–∏–±–∫–æ–π:', e);
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fallback –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É
      showFallbackButton(data);
      // –ò–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        setStatus('success', '‚úÖ –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –°–ø–∞—Å–∏–±–æ!');
        sendBtn.textContent = '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
      }, 1500);
    });

    function setStatus(type, message) {
      if(!message) {
        statusDiv.innerHTML = '';
        return;
      }
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function showFallbackButton(data) {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É
      const oldBtn = document.querySelector('.fallback-button');
      if(oldBtn) oldBtn.remove();

      const fallbackBtn = document.createElement('button');
      fallbackBtn.className = 'send-btn fallback-button';
      fallbackBtn.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ —á–∞—Ç (–µ—Å–ª–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)';
      fallbackBtn.onclick = () => {
        const encoded = btoa(JSON.stringify(data));
        const fallbackMessage = `WEBAPP_DATA:${encoded}`;
        tg.openTelegramLink(`https://t.me/new_otziv_Bot?text=${encodeURIComponent(fallbackMessage)}`);
        setStatus('info', '‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã! –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
        fallbackBtn.disabled = true;
      };
      statusDiv.appendChild(fallbackBtn);
    }

    textarea.addEventListener('input', () => {
      if(textarea.value.trim().length > 0 && !sendBtn.disabled) {
        setStatus(null, '');
      }
    });
  </script>
</body>
</html>
