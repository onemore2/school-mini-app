<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–®–∫–æ–ª—å–Ω—ã–π –ß–∞—Ç</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --primary: #FFD700;
      --secondary: #FF8C00;
      --dark: #1a1a1a;
      --light: #f9f9f9;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    body {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      padding: 20px 0;
    }
    h1 {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .id-badge {
      background: rgba(255,255,255,0.3);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-family: monospace;
      margin-top: 8px;
      display: inline-block;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      margin: 12px 0;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
    }
    .btn:active {
      transform: translateY(1px);
    }
    .btn-idea { background: #4CAF50; color: white; }
    .btn-question { background: #2196F3; color: white; }
    .btn-complaint { background: #F44336; color: white; }
    .btn-secondary { background: white; color: var(--dark); }
    .hidden { display: none !important; }
    textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid #ddd;
      font-size: 16px;
      resize: vertical;
      margin: 10px 0;
    }
    .preview {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .status {
      text-align: center;
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
    }
    .rules {
      background: white;
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="screen-main">
      <header>
        <h1>üè´ –®–∫–æ–ª—å–Ω—ã–π –ß–∞—Ç</h1>
        <div class="id-badge" id="user-id">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </header>
      <button class="btn btn-secondary" onclick="showRules()">üìú –ü—Ä–∞–≤–∏–ª–∞</button>
      <button class="btn btn-secondary" onclick="startFeedback()">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div id="screen-type" class="hidden">
      <header><h1>–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h1></header>
      <button class="btn btn-idea" onclick="selectType('idea')">üí° –ò–¥–µ—è</button>
      <button class="btn btn-question" onclick="selectType('question')">‚ùì –í–æ–ø—Ä–æ—Å</button>
      <button class="btn btn-complaint" onclick="selectType('complaint')">‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞</button>
      <button class="btn btn-secondary" onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ -->
    <div id="screen-input" class="hidden">
      <header><h1 id="input-title">‚úçÔ∏è –û–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ</h1></header>
      <textarea id="feedback-text" placeholder="–ù–∞–ø–∏—à–∏ —Å—é–¥–∞ —Å–≤–æ—ë –æ–±—Ä–∞—â–µ–Ω–∏–µ..."></textarea>
      <button class="btn btn-secondary" onclick="previewFeedback()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      <button class="btn btn-secondary" onclick="backToType()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div id="screen-preview" class="hidden">
      <header><h1>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h1></header>
      <div class="preview" id="preview-content"></div>
      <button class="btn btn-secondary" onclick="sendFeedback()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="btn btn-secondary" onclick="editFeedback()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn btn-secondary" onclick="backToMain()">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>

    <!-- –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ -->
    <div id="screen-success" class="hidden">
      <div class="status">‚úÖ –û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</div>
      <button class="btn btn-secondary" onclick="backToMain()">üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
    </div>

    <!-- –ü—Ä–∞–≤–∏–ª–∞ -->
    <div id="screen-rules" class="hidden">
      <header><h1>üìú –ü—Ä–∞–≤–∏–ª–∞</h1></header>
      <div class="rules">
        <p><b>1.</b> –ù–µ –æ—Å–∫–æ—Ä–±–ª—è–π –¥—Ä—É–≥–∏—Ö.</p>
        <p><b>2.</b> –ù–µ —Å–ø–∞–º—å ‚Äî –º–∞–∫—Å–∏–º—É–º 5 –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å.</p>
        <p><b>3.</b> –ù–µ –≤—ã–¥–∞–≤–∞–π —Å–µ–±—è ‚Äî —Ç–≤–æ–π ID –∞–Ω–æ–Ω–∏–º–µ–Ω.</p>
        <p><b>4.</b> –ó–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è ‚Äî –±–∞–Ω –Ω–∞ 24 —á–∞—Å–∞.</p>
        <p><b>5.</b> –¶–µ–ª—å ‚Äî —Å–¥–µ–ª–∞—Ç—å —à–∫–æ–ª—É –ª—É—á—à–µ!</p>
      </div>
      <button class="btn btn-secondary" onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <script>
    const CATEGORIES = {
      idea: 'üí° –ò–¥–µ—è',
      question: '‚ùì –í–æ–ø—Ä–æ—Å',
      complaint: '‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞'
    };

    let currentType = null;
    let anonId = null;

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
    function generateAnonymousId() {
      if (localStorage.getItem('school_anon_id')) {
        return localStorage.getItem('school_anon_id');
      }
      const letters = Array(4).fill().map(() => String.fromCharCode(65 + Math.floor(Math.random() * 26))).join('');
      const numbers = Array(2).fill().map(() => Math.floor(Math.random() * 10)).join('');
      const id = `STU-${letters}${numbers}`;
      localStorage.setItem('school_anon_id', id);
      return id;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = () => {
      anonId = generateAnonymousId();
      document.getElementById('user-id').textContent = anonId;
    };

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    function showScreen(id) {
      document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function backToMain() { showScreen('screen-main'); }
    function showRules() { showScreen('screen-rules'); }

    function startFeedback() {
      showScreen('screen-type');
    }

    function selectType(type) {
      currentType = type;
      document.getElementById('input-title').textContent = `‚úçÔ∏è ${CATEGORIES[type]}`;
      document.getElementById('feedback-text').value = '';
      showScreen('screen-input');
    }

    function previewFeedback() {
      const text = document.getElementById('feedback-text').value.trim();
      if (!text) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å!');
        return;
      }
      const preview = `<b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</b> ${CATEGORIES[currentType]}<br><br><b>–¢–µ–∫—Å—Ç:</b><br>${text.replace(/\n/g, '<br>')}`;
      document.getElementById('preview-content').innerHTML = preview;
      showScreen('screen-preview');
    }

    function editFeedback() {
      showScreen('screen-input');
    }

    function backToType() {
      showScreen('screen-type');
    }

    async function sendFeedback() {
      const text = document.getElementById('feedback-text').value.trim();
      const payload = {
        anonymous_id: anonId,
        type: currentType,
        text: text,
        timestamp: new Date().toISOString()
      };

      const status = document.querySelector('.status');
      status.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞...';

      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 }
          });
          showScreen('screen-success');
        } else {
          const error = await res.json();
          alert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å'));
          backToMain();
        }
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.');
        backToMain();
      }
    }
  </script>
</body>
</html>