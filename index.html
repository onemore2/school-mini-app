<script>
  if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.setHeaderColor('#000000');
    Telegram.WebApp.setBackgroundColor('#000000');
  }

  let category = 'idea';
  document.querySelectorAll('.category-btn').forEach(btn => {
    // Используем pointerup — работает везде
    btn.addEventListener('pointerup', () => {
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      category = btn.dataset.type;
    });
  });

  let anonId = localStorage.getItem('anonId');
  if (!anonId) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ012345';
    anonId = 'STU-' + Array.from({length: 6}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    localStorage.setItem('anonId', anonId);
  }

  const sendBtn = document.getElementById('send');
  const textArea = document.getElementById('text');

  // Основной обработчик — pointerup (работает на ПК и на телефоне)
  sendBtn.addEventListener('pointerup', () => {
    const text = textArea.value.trim();
    if (!text) {
      if (Telegram?.WebApp) {
        Telegram.WebApp.showAlert('Введите текст обращения!');
      }
      return;
    }

    const data = {
      action: 'submit',
      anonymous_id: anonId,
      type: category,
      text: text
    };

    if (Telegram?.WebApp) {
      Telegram.WebApp.sendData(JSON.stringify(data));
    }
  });

  // Дополнительно: обработка Enter в поле (опционально)
  textArea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.ctrlKey) {
      sendBtn.dispatchEvent(new PointerEvent('pointerup'));
    }
  });
</script>
