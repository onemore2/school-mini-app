<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Школьный Чат</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* Все стили из твоего прошлого варианта — оставляем без изменений */
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;min-height:100vh;padding:20px}
    .container{max-width:100%;margin:0 auto}
    .header{text-align:center;margin-bottom:30px;padding:20px 0}
    .header h1{font-size:24px;margin-bottom:8px;text-shadow:0 2px 4px rgba(0,0,0,0.3)}
    .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:20px;padding:25px;border:1px solid rgba(255,255,255,0.2)}
    .category-buttons{display:grid;gap:12px;margin-bottom:25px}
    .category-btn{background:rgba(255,255,255,0.15);border:2px solid transparent;border-radius:15px;padding:18px;color:white;font-size:16px;font-weight:500;cursor:pointer;transition:all .3s;text-align:left}
    .category-btn:hover{background:rgba(255,255,255,0.25);transform:translateY(-2px)}
    .category-btn.active{background:rgba(255,255,255,0.3);border-color:rgba(255,255,255,0.5);box-shadow:0 8px 25px rgba(0,0,0,0.2)}
    textarea{width:100%;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:15px;padding:18px;color:white;font-size:16px;resize:vertical;min-height:140px}
    textarea::placeholder{color:rgba(255,255,255,0.7)}
    textarea:focus{outline:none;border-color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.15)}
    .send-btn{width:100%;background:linear-gradient(135deg,#4CAF50,#45a049);border:none;border-radius:15px;padding:20px;color:white;font-size:18px;font-weight:600;cursor:pointer;margin-top:10px;box-shadow:0 8px 25px rgba(76,175,80,0.3);transition:all .3s}
    .send-btn:hover:not(:disabled){transform:translateY(-3px)}
    .send-btn:disabled{background:rgba(255,255,255,0.2);cursor:not-allowed}
    .status{text-align:center;padding:15px;border-radius:15px;margin:20px 0;font-weight:500}
    .status.success{background:rgba(76,175,80,0.3);border:1px solid rgba(76,175,80,0.5)}
    .status.error{background:rgba(244,67,54,0.3);border:1px solid rgba(244,67,54,0.5)}
    .anonymous-id{background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;margin:20px 0;font-family:'Courier New',monospace;font-size:14px;border:1px solid rgba(255,255,255,0.2)}
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>Школьный Чат</h1><p>Анонимные обращения</p></div>
    <div class="card">
      <div class="category-buttons">
        <button class="category-btn active" data-category="idea">Идея</button>
        <button class="category-btn" data-category="question">Вопрос</button>
        <button class="category-btn" data-category="complaint">Проблема</button>
      </div>
      <div class="textarea-container">
        <textarea id="text" placeholder="Опишите подробно..."></textarea>
      </div>
      <div id="status"></div>
      <div class="anonymous-id">Ваш номер: <span id="anonymousId">...</span></div>
      <button id="send" class="send-btn">Отправить обращение</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const textarea = document.getElementById('text');
    const statusDiv = document.getElementById('status');
    const sendBtn = document.getElementById('send');
    let category = 'idea';
    let anonymousId = '';
    let fallbackUsed = false;

    function setStatus(type, msg) {
      statusDiv.innerHTML = msg ? `<div class="status ${type}">${msg}</div>` : '';
    }

    function generateId() {
      const l = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const n = '0123456789';
      let id = 'STU-';
      for(let i=0;i<4;i++) id += l[Math.floor(Math.random()*26)];
      for(let i=0;i<2;i++) id += n[Math.floor(Math.random()*10)];
      return id;
    }

    document.getElementById('anonymousId').textContent = anonymousId = generateId();

    document.querySelectorAll('.category-btn').forEach(b => {
      b.addEventListener('click', () => {
        document.querySelectorAll('.category-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        category = b.dataset.category;
      });
    });

    sendBtn.onclick = () => {
      const text = textarea.value.trim();
      if (!text || text.length < 10) {
        setStatus('error', 'Текст должен быть не короче 10 символов');
        return;
      }

      sendBtn.disabled = true;
      sendBtn.textContent = 'Отправка...';
      setStatus('info', 'Отправляем...');

      const payload = {action:"submit_feedback", anonymous_id:anonymousId, type:category, text, timestamp:new Date().toISOString()};
      const json = JSON.stringify(payload);
      const base64 = btoa(unescape(encodeURIComponent(json)));
      const magic = "WEBAPP_DATA:" + base64;

      let sentViaSendData = false;

      // Попытка №1 — нормальный sendData
      try {
        tg.sendData(json);
        sentViaSendData = true;
        console.log('sendData вызван');
      } catch(e) { console.log('sendData упал сразу'); }

      // Если sendData сработал — ждём подтверждение 1.5 сек
      const timeout = setTimeout(() => {
        if (!sentViaSendData || !window.__webapp_data_confirmed) {
          fallback();
        }
      }, 1500);

      // Подтверждение от Telegram (если sendData дошёл)
      window.__webapp_data_confirmed = false;
      tg.onEvent('web_app_data_send', () => {
        window.__webapp_data_confirmed = true;
        clearTimeout(timeout);
        if (!fallbackUsed) {
          success();
        }
      });

      // Fallback — 100% надёжный способ
      function fallback() {
        if (fallbackUsed) return;
        fallbackUsed = true;
        const url = `https://t.me/new_otziv_Bot?text=${encodeURIComponent(magic)}`;  // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
        setStatus('success', 'Открываем чат — нажмите «Отправить»');
        sendBtn.textContent = 'Открываем...';
        setTimeout(() => {
          tg.openTelegramLink(url);
          setTimeout(() => tg.close(), 1200);
        }, 800);
      }

      function success() {
        setStatus('success', 'Обращение отправлено!');
        sendBtn.textContent = 'Отправлено';
        setTimeout(() => tg.close(), 1500);
      }
    };

    // Ctrl+Enter
    textarea.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') sendBtn.click();
    });
  </script>
</body>
</html>
